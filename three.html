<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>電流磁效應虛擬實驗室</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f9ff;
        }
        .compass-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        
        /* Custom animations for current flow */
        @keyframes flow-ns {
            0% { transform: translateY(-100%); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(100%); opacity: 0; }
        }
        @keyframes flow-sn {
            0% { transform: translateY(100%); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(-100%); opacity: 0; }
        }
        @keyframes flow-we {
            0% { transform: translateX(-100%); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }
        @keyframes flow-ew {
            0% { transform: translateX(100%); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(-100%); opacity: 0; }
        }
        
        .animate-flow-ns { animation: flow-ns 1.5s infinite linear; }
        .animate-flow-sn { animation: flow-sn 1.5s infinite linear; }
        .animate-flow-we { animation: flow-we 1.5s infinite linear; }
        .animate-flow-ew { animation: flow-ew 1.5s infinite linear; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Inline Icons ---
        const Zap = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
            </svg>
        );
        const RefreshCw = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M21 2v6h-6"></path>
                <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
                <path d="M3 22v-6h6"></path>
                <path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path>
            </svg>
        );
        const Layers = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                <polyline points="2 17 12 22 22 17"></polyline>
                <polyline points="2 12 12 17 22 12"></polyline>
            </svg>
        );
        const MoveVertical = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <polyline points="8 18 12 22 16 18"></polyline>
                <polyline points="8 6 12 2 16 6"></polyline>
                <line x1="12" y1="2" x2="12" y2="22"></line>
            </svg>
        );
        const MoveHorizontal = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <polyline points="18 8 22 12 18 16"></polyline>
                <polyline points="6 8 2 12 6 16"></polyline>
                <line x1="2" y1="12" x2="22" y2="12"></line>
            </svg>
        );
        const Info = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
        );
        const Power = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
                <line x1="12" y1="2" x2="12" y2="12"></line>
            </svg>
        );

        // --- Physics Hook for Spring Animation (Wobble Effect) ---
        const useSpringAnimation = (targetValue) => {
            const [value, setValue] = useState(targetValue);
            const velocity = useRef(0);
            const current = useRef(targetValue);
            const animationFrame = useRef(null);

            useEffect(() => {
                const spring = 0.15; // Stiffness
                const friction = 0.08; // Damping
                const stopThreshold = 0.01;

                const animate = () => {
                    const diff = targetValue - current.current;
                    const acceleration = diff * spring;
                    velocity.current += acceleration;
                    velocity.current *= (1 - friction);
                    
                    current.current += velocity.current;
                    setValue(current.current);

                    if (Math.abs(diff) > stopThreshold || Math.abs(velocity.current) > stopThreshold) {
                        animationFrame.current = requestAnimationFrame(animate);
                    } else {
                        current.current = targetValue;
                        setValue(targetValue);
                    }
                };

                cancelAnimationFrame(animationFrame.current);
                animationFrame.current = requestAnimationFrame(animate);

                return () => cancelAnimationFrame(animationFrame.current);
            }, [targetValue]);

            return value;
        };

        // --- Components ---

        const Compass = ({ targetRotation, wireAbove }) => {
            const animatedRotation = useSpringAnimation(targetRotation);

            return (
                <div className={`relative w-48 h-48 bg-white rounded-full border-4 border-gray-300 compass-shadow flex items-center justify-center ${wireAbove ? 'z-0' : 'z-20'}`}>
                    <div className="absolute inset-0 flex items-center justify-center">
                        <div className="absolute top-2 font-bold text-gray-500">N</div>
                        <div className="absolute bottom-2 font-bold text-gray-500">S</div>
                        <div className="absolute left-2 font-bold text-gray-500">W</div>
                        <div className="absolute right-2 font-bold text-gray-500">E</div>
                        <div className="absolute w-full h-0.5 bg-gray-200 rotate-0"></div>
                        <div className="absolute w-full h-0.5 bg-gray-200 rotate-45"></div>
                        <div className="absolute w-full h-0.5 bg-gray-200 rotate-90"></div>
                        <div className="absolute w-full h-0.5 bg-gray-200 rotate-135"></div>
                    </div>
                    <div 
                        className="relative w-4 h-36 drop-shadow-md"
                        style={{ transform: `rotate(${animatedRotation}deg)` }}
                    >
                        <div className="absolute top-0 left-0 w-0 h-0 border-l-[8px] border-r-[8px] border-b-[72px] border-l-transparent border-r-transparent border-b-red-600"></div>
                        <div className="absolute bottom-0 left-0 w-0 h-0 border-l-[8px] border-r-[8px] border-t-[72px] border-l-transparent border-r-transparent border-t-slate-700"></div>
                        <div className="absolute top-1/2 left-1/2 w-3 h-3 bg-yellow-400 rounded-full -translate-x-1/2 -translate-y-1/2 border border-yellow-600 z-10"></div>
                    </div>
                </div>
            );
        };

        const Wire = ({ orientation, isPowerOn, currentDirection, wireAbove }) => {
            const isVertical = orientation === 'NS';
            let animClass = '';
            if (isPowerOn) {
                if (isVertical) {
                    animClass = currentDirection === 'NtoS' ? 'animate-flow-ns' : 'animate-flow-sn';
                } else {
                    animClass = currentDirection === 'WtoE' ? 'animate-flow-we' : 'animate-flow-ew';
                }
            }

            return (
                <div 
                    className={`absolute pointer-events-none flex items-center justify-center overflow-visible transition-all duration-300
                        ${isVertical ? 'w-8 h-1/2' : 'h-8 w-1/2'} 
                        ${wireAbove ? 'z-20' : 'z-0 opacity-100'}
                    `}
                >
                    {/* The Wire Itself */}
                    <div className={`${isVertical ? 'w-2 h-full' : 'h-2 w-full'} bg-slate-900 shadow-sm relative`}>
                        {isPowerOn && (
                            <div className="absolute inset-0 flex items-center justify-center opacity-90">
                                <div className={`w-full h-full flex ${isVertical ? 'flex-col' : 'flex-row'} justify-around items-center overflow-hidden`}>
                                   {[1, 2, 3, 4, 5].map(i => (
                                       <div key={i} className={`${animClass} text-orange-400 font-bold text-xl drop-shadow-md`}>
                                            {isVertical ? (currentDirection === 'NtoS' ? '↓' : '↑') : (currentDirection === 'WtoE' ? '→' : '←')}
                                       </div>
                                   ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const Battery = ({ isPowerOn, polarity, orientation }) => {
            const isHorizontal = orientation === 'WE';
            // Scale reduced battery size
            const containerStyle = isHorizontal 
                ? "flex-row h-16 w-36 px-3 py-1.5" // Reduced width/height
                : "flex-col w-14 h-28 py-3 px-1.5";
            
            const batteryBodyStyle = isHorizontal
                ? "h-12 w-24 flex-row px-1.5"
                : "w-12 h-24 flex-col py-1.5";

            const nippleStyle = isHorizontal
                ? "absolute -right-1 h-4 w-1.5 bg-gray-400 rounded-r-sm top-1/2 -translate-y-1/2" 
                : "absolute -top-1 w-4 h-1.5 bg-gray-400 rounded-t-sm left-1/2 -translate-x-1/2";

            const rotationClass = polarity === 'reversed' ? 'rotate-180' : '';

            // Font sizes reduced for smaller battery
            const symbolClass = `text-yellow-400 font-bold text-base select-none ${isHorizontal ? 'order-last' : ''}`;
            const minusClass = "text-gray-400 font-bold text-base select-none";

            return (
                <div className={`flex items-center justify-center bg-transparent transition-all duration-500 ${containerStyle}`}>
                    <div className={`relative bg-slate-800 rounded-md flex items-center justify-between shadow-xl border border-slate-600 transition-transform duration-500 ${batteryBodyStyle} ${rotationClass}`}>
                        <div className={nippleStyle}></div>
                        <div className={symbolClass}>+</div>
                        <div className={`${isHorizontal ? 'h-full w-full py-1.5 px-0.5' : 'w-full h-full px-1.5 py-0.5'}`}>
                           <div className={`bg-blue-500/20 rounded border border-blue-500/50 w-full h-full relative overflow-hidden`}>
                                <div className={`absolute bg-blue-500 transition-all duration-300 
                                    ${isHorizontal 
                                        ? (isPowerOn ? 'w-full h-full opacity-80' : 'w-0 h-full') 
                                        : (isPowerOn ? 'h-full w-full opacity-80 bottom-0' : 'h-0 w-full bottom-0')
                                    }`}></div>
                           </div>
                        </div>
                        <div className={minusClass}>-</div>
                    </div>
                </div>
            );
        };

        const CircuitWires = ({ orientation }) => {
            const isVertical = orientation === 'NS';
            
            // Note: 
            // 1. vectorEffect="non-scaling-stroke" ensures stroke width is always 8px on screen, matching w-2.
            // 2. Coordinates: The central wire (Wire component) is 50% length.
            //    So it occupies from 25% to 75% of the container.
            //    We must connect exactly to 25 and 75 to avoid gaps.
            
            if (isVertical) {
                // Vertical Layout
                // Central Wire: x=50, y=25 to y=75
                return (
                    <svg className="absolute inset-0 w-full h-full pointer-events-none z-10" viewBox="0 0 100 100" preserveAspectRatio="none">
                        {/* Top Connection: (50, 25) -> Up -> Right -> Battery Top */}
                        <path d="M 50 25.5 L 50 10 L 92 10 L 92 38" fill="none" stroke="#0f172a" strokeWidth="8" vectorEffect="non-scaling-stroke" strokeLinecap="square" strokeLinejoin="round" />
                        
                        {/* Bottom Connection: (50, 75) -> Down -> Right -> Battery Bottom */}
                        <path d="M 50 74.5 L 50 90 L 92 90 L 92 62" fill="none" stroke="#0f172a" strokeWidth="8" vectorEffect="non-scaling-stroke" strokeLinecap="square" strokeLinejoin="round" />
                    </svg>
                );
            } else {
                // Horizontal Layout
                // Central Wire: y=50, x=25 to x=75
                return (
                    <svg className="absolute inset-0 w-full h-full pointer-events-none z-10" viewBox="0 0 100 100" preserveAspectRatio="none">
                        {/* Left Connection: (25, 50) -> Left -> Down -> Battery Left */}
                        <path d="M 25.5 50 L 10 50 L 10 88 L 35 88" fill="none" stroke="#0f172a" strokeWidth="8" vectorEffect="non-scaling-stroke" strokeLinecap="square" strokeLinejoin="round" />
                        
                        {/* Right Connection: (75, 50) -> Right -> Down -> Battery Right */}
                        <path d="M 74.5 50 L 90 50 L 90 88 L 65 88" fill="none" stroke="#0f172a" strokeWidth="8" vectorEffect="non-scaling-stroke" strokeLinecap="square" strokeLinejoin="round" />
                    </svg>
                );
            }
        };

        const App = () => {
            const [isPowerOn, setIsPowerOn] = useState(false);
            const [wirePosition, setWirePosition] = useState('above');
            const [polarity, setPolarity] = useState('normal');
            const [orientation, setOrientation] = useState('NS');

            const currentDirection = orientation === 'NS' 
                ? (polarity === 'normal' ? 'NtoS' : 'StoN') 
                : (polarity === 'normal' ? 'WtoE' : 'EtoW');

            const calculateRotation = () => {
                if (!isPowerOn) return 0;
                // Deflection amount updated to 40 degrees
                const DEFLECTION_AMOUNT = 40;

                if (orientation === 'NS') {
                    let angle = 0;
                    if (currentDirection === 'NtoS') angle = DEFLECTION_AMOUNT;
                    else angle = -DEFLECTION_AMOUNT;
                    if (wirePosition === 'below') angle = -angle;
                    return angle;
                } else {
                    return 0;
                }
            };

            const rotation = calculateRotation();

            const getExplanation = () => {
                if (!isPowerOn) return "請開啟電源以觀察實驗現象。";
                
                if (orientation === 'WE') {
                    let bFieldDir = '';
                    if (currentDirection === 'WtoE') {
                        bFieldDir = wirePosition === 'above' ? '南方' : '北方';
                    } else {
                        bFieldDir = wirePosition === 'above' ? '北方' : '南方';
                    }

                    if (bFieldDir === '南方') {
                        return '導線為東西向，磁場指向南方。雖然與地磁方向相反，但在一般實驗條件下，指針通常維持不偏轉（或極不穩定）。';
                    } else {
                        return '導線為東西向，磁場指向北方。與地磁方向相同，指針受到更強的磁力指引，維持指向北方不偏轉。';
                    }
                }

                const dirText = currentDirection === 'NtoS' ? '由北向南' : '由南向北';
                const posText = wirePosition === 'above' ? '上方' : '下方';
                const resultText = rotation > 0 ? '向東' : '向西';
                
                return `電流方向${dirText}，導線位於指北針${posText}。根據安培右手定則，磁場方向指向${resultText}方，因此N極${resultText}偏轉。`;
            };

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-5xl mx-auto">
                    <header className="mb-8 text-center">
                        <h1 className="text-3xl font-bold text-slate-800 flex items-center justify-center gap-3">
                            <Zap className="text-yellow-500 fill-current" />
                            電流磁效應實驗室
                        </h1>
                        <p className="text-slate-600 mt-2">觀察指北針（N極紅色）的偏轉情形</p>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        {/* LEFT: Controls */}
                        <div className="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 h-fit space-y-6">
                            <h2 className="text-xl font-bold text-slate-700 border-b pb-2">實驗控制台</h2>
                            
                            <div className="space-y-2">
                                <label className="text-sm font-semibold text-slate-500">總電源</label>
                                <button 
                                    onClick={() => setIsPowerOn(!isPowerOn)}
                                    className={`w-full py-4 rounded-xl font-bold text-lg transition-all shadow-md flex items-center justify-center gap-2
                                        ${isPowerOn 
                                            ? 'bg-red-500 text-white hover:bg-red-600 shadow-red-200 ring-2 ring-red-300' 
                                            : 'bg-green-500 text-white hover:bg-green-600 shadow-green-200'}
                                    `}
                                >
                                    <Power size={24} fill={isPowerOn ? "currentColor" : "none"} />
                                    {isPowerOn ? '斷開電路 (OFF)' : '接通電路 (ON)'}
                                </button>
                            </div>

                            <div className="space-y-2">
                                <label className="text-sm font-semibold text-slate-500">導線位置</label>
                                <div className="grid grid-cols-2 gap-2 bg-slate-100 p-1 rounded-lg">
                                    <button 
                                        onClick={() => setWirePosition('above')}
                                        className={`py-2 rounded-md text-sm font-medium transition-all flex items-center justify-center gap-1
                                            ${wirePosition === 'above' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                    >
                                        <Layers size={16} /> 指北針上方
                                    </button>
                                    <button 
                                        onClick={() => setWirePosition('below')}
                                        className={`py-2 rounded-md text-sm font-medium transition-all flex items-center justify-center gap-1
                                            ${wirePosition === 'below' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                    >
                                        <Layers size={16} className="rotate-180" /> 指北針下方
                                    </button>
                                </div>
                            </div>

                            <div className="space-y-2">
                                <label className="text-sm font-semibold text-slate-500">電流方向 (電池極性)</label>
                                <button 
                                    onClick={() => setPolarity(p => p === 'normal' ? 'reversed' : 'normal')}
                                    className="w-full py-3 bg-white border-2 border-slate-200 rounded-xl text-slate-700 font-medium hover:border-blue-400 hover:bg-blue-50 transition-all flex items-center justify-center gap-2"
                                >
                                    <RefreshCw size={18} />
                                    切換電池方向
                                </button>
                            </div>

                            <div className="space-y-2">
                                <label className="text-sm font-semibold text-slate-500">導線走向</label>
                                <div className="grid grid-cols-2 gap-2 bg-slate-100 p-1 rounded-lg">
                                    <button 
                                        onClick={() => setOrientation('NS')}
                                        className={`py-2 rounded-md text-sm font-medium transition-all flex items-center justify-center gap-1
                                            ${orientation === 'NS' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                    >
                                        <MoveVertical size={16} /> 南北向
                                    </button>
                                    <button 
                                        onClick={() => setOrientation('WE')}
                                        className={`py-2 rounded-md text-sm font-medium transition-all flex items-center justify-center gap-1
                                            ${orientation === 'WE' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                    >
                                        <MoveHorizontal size={16} /> 東西向
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* MIDDLE: Simulation Area */}
                        <div className="lg:col-span-2 flex flex-col gap-6">
                            <div className="bg-slate-50 rounded-2xl border border-slate-200 p-8 flex flex-col items-center justify-center relative min-h-[500px] overflow-hidden shadow-inner">
                                <div className="absolute top-4 text-slate-400 font-bold tracking-widest text-sm">北方 (North)</div>
                                <div className="absolute bottom-4 text-slate-400 font-bold tracking-widest text-sm">南方 (South)</div>
                                <div className="absolute left-4 text-slate-400 font-bold tracking-widest text-sm writing-mode-vertical">西方</div>
                                <div className="absolute right-4 text-slate-400 font-bold tracking-widest text-sm writing-mode-vertical">東方</div>

                                <div className="relative w-full h-full flex items-center justify-center z-10">
                                    <CircuitWires orientation={orientation} />
                                    <div className={`absolute transition-all duration-500 z-20 
                                        ${orientation === 'NS' 
                                            ? 'right-4 top-1/2 -translate-y-1/2' 
                                            : 'bottom-4 left-1/2 -translate-x-1/2'}`}>
                                        <Battery isPowerOn={isPowerOn} polarity={polarity} orientation={orientation} />
                                    </div>

                                    <div className="relative flex items-center justify-center w-full h-full">
                                        <Wire 
                                            orientation={orientation} 
                                            isPowerOn={isPowerOn} 
                                            currentDirection={currentDirection} 
                                            wireAbove={wirePosition === 'above'} 
                                        />
                                        <Compass 
                                            targetRotation={rotation} 
                                            wireAbove={wirePosition === 'above'} 
                                        />
                                    </div>
                                </div>
                            </div>

                            <div className={`rounded-xl p-5 border transition-colors duration-300 flex items-start gap-4
                                ${isPowerOn ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-gray-200'}`}>
                                <div className={`p-2 rounded-full ${isPowerOn ? 'bg-blue-100 text-blue-600' : 'bg-gray-200 text-gray-500'}`}>
                                    <Info size={24} />
                                </div>
                                <div>
                                    <h3 className="font-bold text-lg text-slate-800 mb-1">實驗觀察</h3>
                                    <p className="text-slate-600 leading-relaxed">
                                        {getExplanation()}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>